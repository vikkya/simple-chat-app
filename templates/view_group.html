{% extends 'base.html' %}
{% block title %} Groups {% endblock %}
{% block content %}
    <div class="row mt-5">
        <div class="col-10 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h1>Welcome to {{ group.group_name }}</h1>
                    <div id="message"></div>
                    <form id="message_input_form" class="row g-3 mt-3">
                        <div class="col-auto">
                            <label for="message_input" class="visually-hidden">Password</label>
                            <input type="text" class="form-control" id="message_input" placeholder="Enter a message" autocomplete="off">
                          </div>
                          <div class="col-auto">
                            <button type="submit" class="btn btn-primary mb-3">Send</button>
                          </div>
                    </form>
                    <p class="text-bold mb-0 mt-3">Group members:</p>
                    {% for mem in group_members %}
                    <span class="badge rounded-pill bg-primary">{{ mem._id.username }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    
    <script>
        // const socket = io.connect("https://vikky-simple-chat-app.herokuapp.com")
        // const socket = io.connect("ws://vikky-simple-chat-app.herokuapp.com/socket.io/?EIO=3&transport=websocket")
        var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
        // const socket = io()
        // const socket = io.connect("http://localhost:5000")
        socket.on("connect", function(){
            socket.emit("join_group", {
                username: "{{ username }}",
                group: "{{ group._id }}"
            });
            let message_input = document.getElementById("message_input")
            document.getElementById("message_input_form").onsubmit = function(e) {
                e.preventDefault()
                let message = message_input.value.trim()
                if (message.length) {
                    socket.emit('send_message', {
                        username: "{{ username }}",
                        group: "{{ group._id }}",
                        message: message
                    })
                }
                message_input.value = ""
                message_input.focus()
            }
        });
    
        window.onbeforeunload = function() {
            socket.emit('leave_room', {
                username: "{{ username }}",
                group: "{{ group._id }}"
            })
        };
    
        socket.on("receive_message", function(data){
            console.log(data)
            const newNode = document.createElement("div")
            newNode.innerHTML = `<b>${data.username}</b>: ${data.message}`
            document.getElementById("message").appendChild(newNode)
        })
        socket.on("join_group_announcement", function(data){
            console.log(data)
            const newNode = document.createElement("div")
            newNode.innerHTML = `${data.username} has joined the group`
            document.getElementById("message").appendChild(newNode)
        })
    </script>
{% endblock %}